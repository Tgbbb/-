<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æœºç®¡ç†çœ‹æ¿ - æ”¯æŒExcelå¯¼å…¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; }
        .modal.active { display: flex; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-10 font-sans">

    <div class="max-w-6xl mx-auto px-4 pt-8">
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">è®¾å¤‡å€Ÿé˜…ä¸­å¿ƒ</h1>
                <p class="text-slate-500 font-medium">å·¥ä½è‡ªåŠ©ç™»è®°ç»ˆç«¯</p>
            </div>
            <div class="flex gap-2">
                <input type="file" id="excel-upload" accept=".xlsx, .xls" class="hidden" onchange="importExcel(this)">
                <button onclick="document.getElementById('excel-upload').click()" class="bg-emerald-600 text-white px-5 py-3 rounded-xl shadow-md font-bold hover:bg-emerald-700 transition active:scale-95 text-sm">
                    ğŸ“‚ å¯¼å…¥ Excel
                </button>
                <button onclick="openAddModal()" class="bg-indigo-600 text-white px-5 py-3 rounded-xl shadow-md font-bold hover:bg-indigo-700 transition active:scale-95 text-sm">
                    + å•å°å½•å…¥
                </button>
            </div>
        </header>

        <div class="bg-white p-4 rounded-2xl shadow-sm mb-8 flex flex-col lg:flex-row gap-4 items-center">
            <div class="relative flex-1 w-full">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
                <input type="text" id="search-input" oninput="render()" placeholder="è¾“å…¥å‹å·æœç´¢..." 
                    class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
            </div>
            <div class="flex gap-1 bg-slate-100 p-1 rounded-xl w-full lg:w-auto">
                <button onclick="setFilter('all')" id="btn-all" class="flex-1 px-6 py-2 rounded-lg font-bold text-sm transition bg-indigo-600 text-white">å…¨éƒ¨</button>
                <button onclick="setFilter('idle')" id="btn-idle" class="flex-1 px-6 py-2 rounded-lg font-bold text-sm transition text-slate-600">ç©ºé—²</button>
                <button onclick="setFilter('busy')" id="btn-busy" class="flex-1 px-6 py-2 rounded-lg font-bold text-sm transition text-slate-600">ä½¿ç”¨ä¸­</button>
            </div>
        </div>

        <div id="device-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <div id="history-modal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800">å†å²è®°å½•</h3>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-500">âœ•</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto flex-1 no-scrollbar"></div>
        </div>
    </div>

    <script>
        let devices = JSON.parse(localStorage.getItem('phone_manager_local')) || [];
        let currentFilter = 'all';

        // === æ–°å¢ï¼šExcel å¯¼å…¥é€»è¾‘ ===
        function importExcel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                if (json.length === 0) {
                    alert("Excel ä¼¼ä¹æ˜¯ç©ºçš„");
                    return;
                }

                // è½¬æ¢æ•°æ®å¹¶åˆå¹¶åˆ°ç°æœ‰åˆ—è¡¨
                const newDevices = json.map(row => ({
                    id: Date.now() + Math.random(),
                    name: row['è®¾å¤‡åç§°'] || row['å‹å·'] || 'æœªçŸ¥è®¾å¤‡',
                    status: 'idle',
                    currentUser: '',
                    borrowTime: '',
                    history: []
                }));

                devices = [...devices, ...newDevices];
                render();
                alert(`æˆåŠŸå¯¼å…¥ ${newDevices.length} å°è®¾å¤‡ï¼`);
                input.value = ''; // æ¸…é™¤ä¸Šä¼ è®°å½•
            };
            reader.readAsArrayBuffer(file);
        }

        // === ä¹‹å‰çš„é€»è¾‘ (éƒ¨åˆ†çœç•¥ï¼Œä¿æŒä¸€è‡´) ===
        function setFilter(type) {
            currentFilter = type;
            ['all', 'idle', 'busy'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                btn.className = t === type ? 
                    'flex-1 px-6 py-2 rounded-lg font-bold text-sm transition bg-indigo-600 text-white' : 
                    'flex-1 px-6 py-2 rounded-lg font-bold text-sm transition text-slate-600';
            });
            render();
        }

        function render() {
            const list = document.getElementById('device-list');
            const keyword = document.getElementById('search-input').value.toLowerCase();
            list.innerHTML = '';

            const filtered = devices.filter(d => {
                const matchesSearch = d.name.toLowerCase().includes(keyword);
                const matchesFilter = (currentFilter === 'all') || 
                                     (currentFilter === 'idle' && d.status === 'idle') || 
                                     (currentFilter === 'busy' && d.status === 'busy');
                return matchesSearch && matchesFilter;
            });

            filtered.forEach(device => {
                const isIdle = device.status === 'idle';
                list.innerHTML += `
                    <div class="bg-white rounded-3xl p-6 shadow-sm border-2 ${isIdle ? 'border-transparent' : 'border-amber-100'} transition">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-lg font-black text-slate-800">${device.name}</h3>
                            <button onclick="deleteDevice(${device.id})" class="text-slate-300 hover:text-red-500 text-xs">åˆ é™¤</button>
                        </div>
                        <div class="mb-6 h-12 flex items-center">
                            ${!isIdle ? `<div class="text-sm font-bold text-slate-700">ğŸ‘¤ ${device.currentUser} <span class="text-[10px] text-slate-400 font-normal ml-2">${device.borrowTime}</span></div>` : `<p class="text-slate-300 text-sm italic">ç©ºé—²</p>`}
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="${isIdle ? `handleBorrow(${device.id})` : `handleReturn(${device.id})`}" class="py-3 rounded-xl font-bold transition ${isIdle ? 'bg-slate-900 text-white' : 'bg-amber-500 text-white'}">${isIdle ? 'ç™»è®°å€Ÿå–' : 'å½’è¿˜'}</button>
                            <button onclick="showHistory(${device.id})" class="py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition">è®°å½•</button>
                        </div>
                    </div>`;
            });
            localStorage.setItem('phone_manager_local', JSON.stringify(devices));
        }

        function deleteDevice(id) {
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                devices = devices.filter(d => d.id !== id);
                render();
            }
        }

        // ... handleBorrow, handleReturn, showHistory ç­‰å‡½æ•°ä¿æŒä¸å˜ ...
        // (æ­¤å¤„ä¸ºäº†ç®€æ´çœç•¥ï¼Œè¯·æ²¿ç”¨ä¸Šä¸€ç‰ˆæœ¬ä¸­çš„ä»£ç )
        
        function handleBorrow(id) {
            const name = prompt("ç™»è®°äººå§“å:");
            if (!name) return;
            const device = devices.find(d => d.id === id);
            const now = new Date().toLocaleString();
            device.status = 'busy'; device.currentUser = name; device.borrowTime = now;
            device.history.unshift({ type: 'å€Ÿå–', user: name, time: now });
            render();
        }
        function handleReturn(id) {
            const device = devices.find(d => d.id === id);
            const name = prompt("ç¡®è®¤å§“å:", device.currentUser);
            if (!name) return;
            device.history.unshift({ type: 'å½’è¿˜', user: name, time: new Date().toLocaleString() });
            device.status = 'idle'; device.currentUser = ''; device.borrowTime = '';
            render();
        }
        function showHistory(id) {
            const device = devices.find(d => d.id === id);
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = device.name;
            content.innerHTML = device.history.map(h => `<div class="mb-2 text-sm"><b>${h.type}</b>: ${h.user} (${h.time})</div>`).join('') || 'æš‚æ— è®°å½•';
            modal.classList.add('active');
        }
        function closeModal() { document.getElementById('history-modal').classList.remove('active'); }
        function openAddModal() {
            const name = prompt("å‹å·:");
            if (name) { devices.push({ id: Date.now(), name, status: 'idle', currentUser: '', borrowTime: '', history: [] }); render(); }
        }

        render();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æœºç®¡ç†ä¸­å¿ƒ - æœ‰å€Ÿæœ‰è¿˜å†å€Ÿä¸éš¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 50; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .admin-menu { display: flex; flex-direction: column; gap: 8px; opacity: 0; pointer-events: none; transform: translateY(10px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .admin-menu.show { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .admin-trigger { transition: transform 0.3s; cursor: pointer; }
        .admin-trigger.open { transform: rotate(90deg); background-color: #475569 !important; }
        #btn-restore-snap { display: none; }
        #btn-restore-snap.unlocked { display: block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24 font-sans text-slate-900">

    <div class="max-w-6xl mx-auto px-4 pt-8">
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">æµ‹è¯•æœºç®¡ç†ä¸­å¿ƒ</h1>
                <p id="snapshot-status" class="text-slate-400 text-xs mt-1 font-medium font-mono italic">æ•°æ®å— 7 æ—¥å¿«ç…§ä¿æŠ¤</p>
            </div>
            <div class="flex gap-2 justify-center">
                <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" class="hidden" onchange="importExcel(this)">
                <button onclick="document.getElementById('excel-upload').click()" class="bg-emerald-600 text-white px-5 py-3 rounded-xl shadow-md font-bold hover:bg-emerald-700 transition active:scale-95 text-sm">ğŸ“‚ æ‰¹é‡å¯¼å…¥</button>
                <button onclick="openFormModal()" class="bg-indigo-600 text-white px-5 py-3 rounded-xl shadow-md font-bold hover:bg-indigo-700 transition active:scale-95 text-sm">+ å•å°å½•å…¥</button>
            </div>
        </header>

        <div class="bg-white p-4 rounded-2xl shadow-sm mb-8 flex flex-col lg:flex-row gap-4 items-center border border-slate-200">
            <div class="relative flex-1 w-full">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
                <input type="text" id="search-input" oninput="render()" placeholder="å‹å·ã€ç³»ç»Ÿã€äººåã€æ‰‹æœºå·(å®Œå…¨åŒ¹é…)..." class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="flex gap-1 bg-slate-100 p-1 rounded-xl w-full lg:w-auto font-bold">
                <button onclick="setFilter('all')" id="btn-all" class="flex-1 px-6 py-2 rounded-lg text-sm bg-indigo-600 text-white shadow-sm">å…¨éƒ¨</button>
                <button onclick="setFilter('idle')" id="btn-idle" class="flex-1 px-6 py-2 rounded-lg text-sm text-slate-600">ç©ºé—²</button>
                <button onclick="setFilter('busy')" id="btn-busy" class="flex-1 px-6 py-2 rounded-lg text-sm text-slate-600">å€Ÿå‡º</button>
            </div>
        </div>

        <div id="device-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <div class="fixed bottom-6 right-6 flex flex-col items-end gap-3 z-40">
        <div id="admin-menu" class="admin-menu">
            <button id="btn-restore-snap" onclick="restoreFromSnapshot()" class="px-4 py-2 bg-amber-600 text-white rounded-lg text-xs font-bold shadow-lg hover:bg-amber-700">âš ï¸ æ¢å¤ 7 æ—¥å‰å¿«ç…§</button>
            <button onclick="document.getElementById('file-backup-import').click()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold shadow-lg hover:bg-blue-700">å¯¼å…¥å¤‡ä»½æ–‡ä»¶</button>
            <button onclick="exportBackup()" class="px-4 py-2 bg-slate-500 text-white rounded-lg text-xs font-bold shadow-lg hover:bg-slate-600">å¯¼å‡ºå½“å‰å¤‡ä»½</button>
            <input type="file" id="file-backup-import" accept=".json" class="hidden" onchange="importBackup(this)">
        </div>
        <button id="admin-trigger" onclick="handleAdminTrigger()" class="admin-trigger w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-105 active:scale-95 transition-all">âš™ï¸</button>
    </div>

    <div id="form-modal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md p-8">
            <h3 class="font-bold mb-6 text-xl">è®¾å¤‡ä¿¡æ¯ç»´æŠ¤</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-3">
                <input type="text" id="input-name" placeholder="å‹å·" class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 font-bold">
                <input type="text" id="input-os" placeholder="ç³»ç»Ÿ" class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="input-phone" placeholder="æ‰‹æœºå·" class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 text-indigo-600">
            </div>
            <button onclick="saveDeviceInfo()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black mt-8 shadow-lg">ä¿å­˜</button>
            <button onclick="closeModal('form-modal')" class="w-full mt-2 text-slate-400 text-sm py-2">å–æ¶ˆ</button>
        </div>
    </div>
    <div id="action-modal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm p-8 text-center">
            <div id="action-icon" class="text-4xl mb-4">ğŸ‘¤</div>
            <h3 id="action-title" class="text-xl font-bold mb-6">ç™»è®°</h3>
            <input type="hidden" id="action-id"><input type="hidden" id="action-type">
            <input type="text" id="action-user" placeholder="è¾“å…¥å§“å" class="w-full px-4 py-4 bg-slate-50 border rounded-2xl outline-none text-center font-bold text-lg mb-8 shadow-inner">
            <div class="flex gap-3"><button onclick="closeModal('action-modal')" class="flex-1 py-4 bg-slate-100 rounded-2xl font-bold text-slate-500">å–æ¶ˆ</button><button id="action-confirm-btn" onclick="confirmAction()" class="flex-1 py-4 text-white rounded-2xl font-bold transition-all active:scale-95">æäº¤</button></div>
        </div>
    </div>
    <div id="history-modal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg flex flex-col max-h-[80vh] overflow-hidden">
            <div class="p-6 border-b flex justify-between bg-slate-50 items-center rounded-t-[2rem]"><h3 id="hist-title" class="font-bold ml-2">æ“ä½œè®°å½•</h3><button onclick="closeModal('history-modal')" class="text-slate-400 p-2">âœ•</button></div>
            <div id="hist-content" class="p-6 overflow-y-auto space-y-3 bg-white no-scrollbar font-medium"></div>
        </div>
    </div>

    <script>
        const DB_NAME = 'DeviceManagerDB_V7';
        const STORES = { DATA: 'devices', SNAPSHOT: 'snapshot', CONFIG: 'config' };
        let db, devices = [], currentFilter = 'all';

        // éšè—å½©è›‹é€»è¾‘
        let clickCount = 0, lastClick = 0;
        function handleAdminTrigger() {
            const now = Date.now();
            if (now - lastClick < 500) clickCount++; else clickCount = 1;
            lastClick = now;
            if (clickCount >= 5) { document.getElementById('btn-restore-snap').classList.add('unlocked'); }
            toggleAdminMenu();
        }

        function toggleAdminMenu() {
            document.getElementById('admin-menu').classList.toggle('show');
            document.getElementById('admin-trigger').classList.toggle('open');
        }

        const initDB = () => {
            return new Promise((res) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    db = e.target.result;
                    Object.values(STORES).forEach(s => { if(!db.objectStoreNames.contains(s)) db.createObjectStore(s, s === STORES.CONFIG ? {} : { keyPath: 'id' }); });
                };
                req.onsuccess = (e) => { db = e.target.result; res(); };
            });
        };

        async function runAutoSnapshot() {
            const tx = db.transaction([STORES.CONFIG, STORES.DATA, STORES.SNAPSHOT], 'readwrite');
            const configStore = tx.objectStore(STORES.CONFIG);
            configStore.get('last_snap_time').onsuccess = (e) => {
                const lastSnap = e.target.result || 0;
                const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000;
                if (Date.now() - lastSnap > SEVEN_DAYS) {
                    const snapStore = tx.objectStore(STORES.SNAPSHOT);
                    snapStore.clear();
                    tx.objectStore(STORES.DATA).getAll().onsuccess = (ev) => {
                        ev.target.result.forEach(item => snapStore.put(item));
                        configStore.put(Date.now(), 'last_snap_time');
                        updateSnapUI(Date.now());
                    };
                } else { updateSnapUI(lastSnap); }
            };
        }

        function updateSnapUI(ts) {
            document.getElementById('snapshot-status').innerText = ts ? `ä¸Šæ¬¡å¿«ç…§: ${new Date(ts).toLocaleDateString()}` : "ä¿æŠ¤å°±ç»ª";
        }

        function restoreFromSnapshot() {
            if (!confirm("âš ï¸ æ¢å¤å¿«ç…§ï¼Ÿ")) return;
            const tx = db.transaction([STORES.DATA, STORES.SNAPSHOT], 'readwrite');
            tx.objectStore(STORES.SNAPSHOT).getAll().onsuccess = (e) => {
                const data = e.target.result;
                const store = tx.objectStore(STORES.DATA);
                store.clear(); data.forEach(i => store.put(i));
                tx.oncomplete = () => window.location.reload();
            };
        }

        async function sync() { db.transaction(STORES.DATA, 'readonly').objectStore(STORES.DATA).getAll().onsuccess = (e) => { devices = e.target.result || []; render(); }; }
        function save(d) { db.transaction(STORES.DATA, 'readwrite').objectStore(STORES.DATA).put(JSON.parse(JSON.stringify(d))); }
        
        // --- æ ¸å¿ƒé€»è¾‘ï¼šç²¾å‡†åŒ¹é…æ‰‹æœºå· ---
        function render() {
            const list = document.getElementById('device-list');
            const kw = document.getElementById('search-input').value.trim().toLowerCase();
            list.innerHTML = '';
            
            devices.filter(d => {
                const matchesFilter = (currentFilter === 'all' || d.status === currentFilter);
                if (!matchesFilter) return false;
                if (!kw) return true;

                // æ‰‹æœºå·ï¼šç²¾å‡†åŒ¹é… (å½•å…¥çš„ phone å¿…é¡»ç­‰äºè¾“å…¥çš„ kw)
                const isPhoneMatch = (d.phone || '').toLowerCase() === kw;
                // å…¶ä»–ï¼šæ¨¡ç³ŠåŒ¹é…
                const isOtherMatch = (
                    d.name.toLowerCase().includes(kw) || 
                    (d.os || '').toLowerCase().includes(kw) || 
                    (d.currentUser || '').toLowerCase().includes(kw)
                );
                return isPhoneMatch || isOtherMatch;
            }).forEach(d => {
                const isIdle = d.status === 'idle';
                list.innerHTML += `
                <div class="bg-white rounded-[2rem] p-6 shadow-sm border-4 ${isIdle?'border-transparent':'border-amber-400'} transition-all hover:shadow-md">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-black text-slate-800 break-all leading-tight">${d.name}</h3>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <span class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded-md">${d.os||'æœªçŸ¥'}</span>
                                ${d.phone ? `<span class="text-[10px] text-slate-500 font-mono bg-slate-100 px-2 py-0.5 rounded-md">ğŸ“ ${d.phone}</span>` : ''}
                            </div>
                        </div>
                        <span class="px-4 py-2 rounded-xl text-[10px] font-black uppercase ${isIdle?'bg-green-500 text-white':'bg-amber-500 text-white'}">${isIdle?'âœ“ ç©ºé—²':'âš  å·²å€Ÿ'}</span>
                    </div>
                    <div class="mb-6 min-h-[50px] flex flex-col justify-center border-t border-slate-50 pt-4">
                        ${!isIdle?`<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold text-xs">${d.currentUser.charAt(0)}</div><div><p class="font-bold text-slate-800 text-sm leading-none">${d.currentUser}</p><p class="text-[9px] text-slate-400 mt-1">${d.borrowTime}</p></div></div>`:'<p class="text-slate-400 text-[10px] italic font-medium">Ready</p>'}
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="openActionModal(${d.id},'${isIdle?'å€Ÿå–':'å½’è¿˜'}')" class="py-3 rounded-xl font-black text-sm transition-all active:scale-95 shadow-sm ${isIdle?'bg-slate-900 text-white':'bg-amber-500 text-white'}">${isIdle?'å€Ÿå–':'å½’è¿˜'}</button>
                        <button onclick="showHistory(${d.id})" class="py-3 text-slate-500 font-bold bg-slate-50 rounded-xl text-xs hover:bg-slate-100 transition-all">è®°å½•</button>
                    </div>
                    <div class="mt-4 flex justify-end gap-3 opacity-20 hover:opacity-100 transition-all duration-300">
                        <button onclick="openFormModal(${d.id})" class="text-[10px] font-bold text-slate-400 hover:text-indigo-600">âœ ç¼–è¾‘</button>
                        <button onclick="deleteDevice(${d.id})" class="text-[10px] font-bold text-slate-300 hover:text-red-500">âœ• åˆ é™¤</button>
                    </div>
                </div>`;
            });
        }

        // ä¸šåŠ¡äº¤äº’ç•¥ (åŒä¸Šç‰ˆ)
        function setFilter(t) { currentFilter = t; ['all','idle','busy'].forEach(i => document.getElementById(`btn-${i}`).className = i === t ? 'flex-1 px-6 py-2 rounded-lg text-sm bg-indigo-600 text-white shadow-sm' : 'flex-1 px-6 py-2 rounded-lg text-sm text-slate-600'); render(); }
        function openFormModal(id=null) { const d = id ? devices.find(i=>i.id===id) : {id:"",name:"",os:"",phone:""}; document.getElementById('edit-id').value=d.id; document.getElementById('input-name').value=d.name; document.getElementById('input-os').value=d.os; document.getElementById('input-phone').value=d.phone; document.getElementById('form-modal').classList.add('active'); lockBodyScroll() }
        function saveDeviceInfo() { const id=document.getElementById('edit-id').value, name=document.getElementById('input-name').value.trim(), os=document.getElementById('input-os').value.trim(), phone=document.getElementById('input-phone').value.trim(); if(!name) return; let d=id?devices.find(i=>i.id==id):{id:Date.now(),name,os,phone,status:'idle',currentUser:'',borrowTime:'',history:[]}; d.name=name; d.os=os; d.phone=phone; if(!id) devices.push(d); save(d); closeModal('form-modal'); render(); }
        function openActionModal(id, type) { const d = devices.find(i=>i.id===id); document.getElementById('action-id').value=id; document.getElementById('action-type').value=type; document.getElementById('action-user').value=(type==='å½’è¿˜')?d.currentUser:""; document.getElementById('action-title').innerText=`${type}ç™»è®°`; document.getElementById('action-confirm-btn').className=`flex-1 py-4 text-white rounded-2xl font-bold shadow-lg ${type==='å€Ÿå–'?'bg-slate-900':'bg-emerald-600'}`; document.getElementById('action-modal').classList.add('active'); lockBodyScroll();}
        function confirmAction() { const id=Number(document.getElementById('action-id').value), type=document.getElementById('action-type').value, user=document.getElementById('action-user').value.trim(); if(!user) return; const d=devices.find(i=>i.id===id), now=new Date().toLocaleString(); if(type==='å€Ÿå–'){ d.status='busy'; d.currentUser=user; d.borrowTime=now; } else { d.status='idle'; d.currentUser=''; d.borrowTime=''; } d.history.unshift({type,user,time:now}); save(d); closeModal('action-modal'); render(); }
        function showHistory(id) { const d=devices.find(i=>i.id===id); document.getElementById('hist-content').innerHTML=d.history.map(h=>`<div class="p-3 bg-slate-50 rounded-xl flex justify-between text-xs font-bold border-l-4 ${h.type==='å€Ÿå–'?'border-amber-400':'border-green-500'}"><span>${h.type}:${h.user}</span><span class="text-slate-400 font-normal">${h.time}</span></div>`).join('')||'æ— '; document.getElementById('history-modal').classList.add('active'); lockBodyScroll();}
        function deleteDevice(id){ if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")){ devices=devices.filter(d=>d.id!==id); db.transaction(STORES.DATA,'readwrite').objectStore(STORES.DATA).delete(id); render(); } }
        function closeModal(id) {
    document.getElementById(id).classList.remove('active');
    // åªæœ‰å½“æ²¡æœ‰æ´»è·ƒå¼¹çª—æ—¶æ‰æ¢å¤æ»šåŠ¨
    if (!document.querySelector('.modal.active')) {
        document.body.style.overflow = '';
    }
}

function lockBodyScroll() {
    document.body.style.overflow = 'hidden';
}
        function exportBackup() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(devices, null, 2)], {type:'application/json'})); a.download = `Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
        function importBackup(input) { const reader = new FileReader(); reader.onload = (e) => { const data = JSON.parse(e.target.result); const tx = db.transaction(STORES.DATA, 'readwrite'); const store = tx.objectStore(STORES.DATA); store.clear(); data.forEach(i => store.put(i)); tx.oncomplete = () => window.location.reload(); }; reader.readAsText(input.files[0]); }
        function importExcel(input) { const reader = new FileReader(); reader.onload = (e) => { const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' }); XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 }).forEach(row => { if(row[0]) { const d = { id: Date.now()+Math.random(), name: row[0].toString(), os: row[1]?row[1].toString():'', phone: row[2]?row[2].toString():'', status: 'idle', currentUser: '', borrowTime: '', history: [] }; devices.push(d); save(d); } }); render(); }; reader.readAsArrayBuffer(input.files[0]); }
        
        async function start() { await initDB(); await sync(); runAutoSnapshot(); }
        start();
    </script>
</body>
</html>

